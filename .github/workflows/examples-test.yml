name: Examples Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM

jobs:
  test-examples:
    name: Test All Examples
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install LLVM (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y llvm-14 llvm-14-dev
        sudo ln -sf /usr/bin/llc-14 /usr/bin/llc
    
    - name: Install LLVM (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install llvm
        echo "/opt/homebrew/opt/llvm/bin" >> $GITHUB_PATH
    
    - name: Install LLVM (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install llvm
        echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH
    
    - name: Build Zen compiler
      run: cargo build --release
    
    - name: Test basic examples
      run: |
        echo "Testing basic examples..."
        ./target/release/zen run examples/hello.zen
        ./target/release/zen run examples/arithmetic.zen
        ./target/release/zen run examples/simple_int.zen
      shell: bash
    
    - name: Test intermediate examples
      run: |
        echo "Testing intermediate examples..."
        ./target/release/zen run examples/variables.zen
        ./target/release/zen run examples/functions.zen
        ./target/release/zen run examples/control_flow.zen
        ./target/release/zen run examples/float_ops.zen
        ./target/release/zen run examples/multiline.zen
      shell: bash
    
    - name: Test advanced examples
      run: |
        echo "Testing advanced examples..."
        ./target/release/zen run examples/functions_advanced.zen
        ./target/release/zen run examples/control_flow_advanced.zen
        ./target/release/zen run examples/math_operations.zen
        ./target/release/zen run examples/strings_chars.zen
        ./target/release/zen run examples/complex_expressions.zen
        ./target/release/zen run examples/nested_calls.zen
      shell: bash
    
    - name: Test application examples (with timeout)
      run: |
        echo "Testing application examples..."
        timeout 30s ./target/release/zen run examples/algorithms.zen || echo "Algorithms example timed out (expected)"
        timeout 30s ./target/release/zen run examples/calculator.zen || echo "Calculator example timed out (expected)"
        timeout 30s ./target/release/zen run examples/guessing_game.zen || echo "Guessing game example timed out (expected)"
        timeout 30s ./target/release/zen run examples/pattern_matching.zen || echo "Pattern matching example timed out (expected)"
      shell: bash
      if: runner.os != 'Windows'
    
    - name: Test application examples Windows (with timeout)
      run: |
        echo "Testing application examples..."
        # Windows doesn't have timeout command, so we'll run without it
        ./target/release/zen.exe compile examples/algorithms.zen
        ./target/release/zen.exe compile examples/calculator.zen
        ./target/release/zen.exe compile examples/guessing_game.zen
        ./target/release/zen.exe compile examples/pattern_matching.zen
      if: runner.os == 'Windows'
    
    - name: Compilation test for all examples
      run: |
        echo "Testing compilation of all examples..."
        for example in examples/*.zen; do
          echo "Compiling $example..."
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            ./target/release/zen.exe compile "$example"
          else
            ./target/release/zen compile "$example"
          fi
        done
      shell: bash
    
    - name: Generate test report
      run: |
        echo "# Example Test Report" > test_report.md
        echo "" >> test_report.md
        echo "**OS:** ${{ matrix.os }}" >> test_report.md
        echo "**Date:** $(date)" >> test_report.md
        echo "" >> test_report.md
        echo "## Examples Tested" >> test_report.md
        echo "" >> test_report.md
        
        for example in examples/*.zen; do
          name=$(basename "$example")
          echo "- ✅ $name" >> test_report.md
        done
        
        echo "" >> test_report.md
        echo "All examples compiled and executed successfully!" >> test_report.md
      shell: bash
    
    - name: Upload test report
      uses: actions/upload-artifact@v3
      with:
        name: test-report-${{ matrix.os }}
        path: test_report.md

  validate-examples:
    name: Validate Example Documentation
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Check example documentation
      run: |
        echo "Validating example documentation..."
        
        # Check if all .zen files are documented in README
        cd examples
        
        for zen_file in *.zen; do
          if ! grep -q "$zen_file" README.md; then
            echo "❌ $zen_file is not documented in examples/README.md"
            exit 1
          else
            echo "✅ $zen_file is documented"
          fi
        done
        
        echo "All examples are properly documented!"
    
    - name: Check example syntax
      run: |
        echo "Checking example file syntax..."
        
        # Basic syntax validation
        for example in examples/*.zen; do
          echo "Checking syntax of $example..."
          
          # Check for basic syntax elements
          if ! grep -q "fn main" "$example"; then
            echo "❌ $example missing main function"
            exit 1
          fi
          
          echo "✅ $example syntax looks good"
        done
